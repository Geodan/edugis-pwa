set search_path=plll_prod,public;

drop table if exists verblijfsobject;

create table verblijfsobject as
select
    v.id,
    v.identificatie,
	openbareruimtenaam,
	huisnummer,
	huisletter,
	huisnummertoevoeging,
	postcode,
	woonplaatsnaam,
	typeadresseerbaarobject,
	v.verblijfsobjectstatus::text,
	string_agg(d."gebruiksdoelverblijfsobject"::text,',' order by d."gebruiksdoelverblijfsobject"::text ASC) gebruiksdoel,
	oppervlakteverblijfsobject,
	pand_opnamedatum,
	pand_opnametype, 
	pand_status, 
	pand_berekeningstype, 
	pand_energieindex, 
	pand_energieklasse, 
	pand_energielabel_is_prive, 
	pand_is_op_basis_van_referentie_gebouw, 
	pand_gebouwklasse, 
	meting_geldig_tot, 
	pand_registratiedatum, 
	pand_detailaanduiding, 
	pand_gebouwtype, 
	pand_gebouwsubtype, 
	pand_projectnaam, 
	pand_projectobject, 
	pand_sbicode, 
	pand_gebruiksoppervlakte_thermische_zone, 
	pand_energiebehoefte, 
	pand_eis_energiebehoefte, 
	pand_primaire_fossiele_energie, 
	pand_eis_primaire_fossiele_energie, 
	pand_primaire_fossiele_energie_emg_forfaitair, 
	pand_aandeel_hernieuwbare_energie, 
	pand_eis_aandeel_hernieuwbare_energie, 
	pand_aandeel_hernieuwbare_energie_emg_forfaitair, 
	pand_temperatuuroverschrijding, 
	pand_eis_temperatuuroverschrijding, 
	pand_warmtebehoefte, 
	pand_energieindex_met_emg_forfaitair,
	geopunt geom,
	null::geometry(point,28992) geom2
  from plllbronnen.verblijfsobject v   
    join plllbronnen.nummeraanduiding n on (v.hoofdadres = n.identificatie)
     join plllbronnen.openbareruimte o on (n.gerelateerdeopenbareruimte=o.identificatie)
      join plllbronnen.woonplaats w on (o.gerelateerdewoonplaats=w.identificatie)
       join plllbronnen.verblijfsobjectgebruiksdoel d on (v.identificatie=d.identificatie)
		left join plllbronnen.v20230101_v2_csv vvc on (v.identificatie = vvc.pand_bagverblijfsobjectid)
  group by 
  	v.id,
  	v.identificatie,
  	o.openbareruimtenaam,
  	n.huisnummer,
  	n.huisletter,
  	n.huisnummertoevoeging,
  	n.postcode,
  	w.woonplaatsnaam,
  	typeadresseerbaarobject,
  	v."verblijfsobjectstatus", 
  	oppervlakteverblijfsobject,
	pand_opnamedatum,
	pand_opnametype, 
	pand_status, 
	pand_berekeningstype, 
	pand_energieindex, 
	pand_energieklasse, 
	pand_energielabel_is_prive, 
	pand_is_op_basis_van_referentie_gebouw, 
	pand_gebouwklasse, 
	meting_geldig_tot, 
	pand_registratiedatum, 
	pand_detailaanduiding, 
	pand_gebouwtype, 
	pand_gebouwsubtype, 
	pand_projectnaam, 
	pand_projectobject, 
	pand_sbicode, 
	pand_gebruiksoppervlakte_thermische_zone, 
	pand_energiebehoefte, 
	pand_eis_energiebehoefte, 
	pand_primaire_fossiele_energie, 
	pand_eis_primaire_fossiele_energie, 
	pand_primaire_fossiele_energie_emg_forfaitair, 
	pand_aandeel_hernieuwbare_energie, 
	pand_eis_aandeel_hernieuwbare_energie, 
	pand_aandeel_hernieuwbare_energie_emg_forfaitair, 
	pand_temperatuuroverschrijding, 
	pand_eis_temperatuuroverschrijding, 
	pand_warmtebehoefte, 
	pand_energieindex_met_emg_forfaitair,
  	geom,
  	geom2
 union
select
    s.id,
    s.identificatie,
	openbareruimtenaam,
	huisnummer,
	huisletter,
	huisnummertoevoeging,
	postcode,
	woonplaatsnaam,
	typeadresseerbaarobject,
	standplaatsstatus::text,
	'woonfunctie' gebruiksdoel,
	st_area(s.geovlak) oppervlakteverblijfsobject,
	pand_opnamedatum,
	pand_opnametype, 
	pand_status, 
	pand_berekeningstype, 
	pand_energieindex, 
	pand_energieklasse, 
	pand_energielabel_is_prive, 
	pand_is_op_basis_van_referentie_gebouw, 
	pand_gebouwklasse, 
	meting_geldig_tot, 
	pand_registratiedatum, 
	pand_detailaanduiding, 
	pand_gebouwtype, 
	pand_gebouwsubtype, 
	pand_projectnaam, 
	pand_projectobject, 
	pand_sbicode, 
	pand_gebruiksoppervlakte_thermische_zone, 
	pand_energiebehoefte, 
	pand_eis_energiebehoefte, 
	pand_primaire_fossiele_energie, 
	pand_eis_primaire_fossiele_energie, 
	pand_primaire_fossiele_energie_emg_forfaitair, 
	pand_aandeel_hernieuwbare_energie, 
	pand_eis_aandeel_hernieuwbare_energie, 
	pand_aandeel_hernieuwbare_energie_emg_forfaitair, 
	pand_temperatuuroverschrijding, 
	pand_eis_temperatuuroverschrijding, 
	pand_warmtebehoefte, 
	pand_energieindex_met_emg_forfaitair,
	st_centroid(s.geovlak) geom,
	st_centroid(s.geovlak) geom2
  from plllbronnen.standplaats s  
    join plllbronnen.nummeraanduiding n2 on (s.hoofdadres = n2.identificatie)
     join plllbronnen.openbareruimte o2 on (n2.gerelateerdeopenbareruimte=o2.identificatie)
      join plllbronnen.woonplaats w2 on (o2.gerelateerdewoonplaats=w2.identificatie)
       left join plllbronnen.v20230101_v2_csv vvc2 on (s.identificatie =vvc2.pand_bagstandplaatsid)
  group by 
  	s.id,
  	s.identificatie,
  	o2.openbareruimtenaam,
  	n2.huisnummer,
  	n2.huisletter,
  	n2.huisnummertoevoeging,
  	n2.postcode,
  	w2.woonplaatsnaam,
  	typeadresseerbaarobject,
  	standplaatsstatus,
  	oppervlakteverblijfsobject,
	pand_opnamedatum,
	pand_opnametype, 
	pand_status, 
	pand_berekeningstype, 
	pand_energieindex, 
	pand_energieklasse, 
	pand_energielabel_is_prive, 
	pand_is_op_basis_van_referentie_gebouw, 
	pand_gebouwklasse, 
	meting_geldig_tot, 
	pand_registratiedatum, 
	pand_detailaanduiding, 
	pand_gebouwtype, 
	pand_gebouwsubtype, 
	pand_projectnaam, 
	pand_projectobject, 
	pand_sbicode, 
	pand_gebruiksoppervlakte_thermische_zone, 
	pand_energiebehoefte, 
	pand_eis_energiebehoefte, 
	pand_primaire_fossiele_energie, 
	pand_eis_primaire_fossiele_energie, 
	pand_primaire_fossiele_energie_emg_forfaitair, 
	pand_aandeel_hernieuwbare_energie, 
	pand_eis_aandeel_hernieuwbare_energie, 
	pand_aandeel_hernieuwbare_energie_emg_forfaitair, 
	pand_temperatuuroverschrijding, 
	pand_eis_temperatuuroverschrijding, 
	pand_warmtebehoefte, 
	pand_energieindex_met_emg_forfaitair,
  	geom,
  	geom2
;

CREATE INDEX verblijfsobjectgeomidx ON plllbronnen.verblijfsobject USING gist (geom);
CREATE INDEX verblijfsobjectgeom2idx ON plllbronnen.verblijfsobject USING gist (geom2);
  